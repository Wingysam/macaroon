# Fly.io Macaroon Tokens

This is the extracted Macaroon token code we use for authorization inside of Fly.io. Because [flyctl](https://github.com/superfly/flyctl), our CLI, is open source, it can't fully exploit
our tokens unless this library is open source as well. So it is.

We don't think you should use any of this code; it's shrink-wrapped around some peculiar details
of our production network, and the data model is Fly-specific. But if it's an interesting to read,
that's great too.


<!-- Code generated by gomarkdoc. DO NOT EDIT -->

# macaroon

```go
import "github.com/superfly/macaroon"
```

Package macaroon defines Fly.io's Macaroon token format.

A [Macaroon](<https://storage.googleapis.com/pub-tools-public-publication-data/pdf/41892.pdf>) is a flexible bearer token based on the idea of "caveats". A caveat limits what a Macaroon can do. A blank Macaroon might represent an all\-access credential; a caveat layered onto that Macaroon might transform it into a read\-only credential; a further caveat might create a credential that can only read, and only to a particular file.

The basic laws of Macaroons:

- Anybody can add a caveat onto a Macaroon, even if they didn't originally issue it.
- A caveat can only further restrict a Macaroon's access; adding a caveat can't even increase access.
- Given a Macaroon with a set of caveats \(A, B, C\), it's cryptographically impossible to remove any caveat, to produce an \(A, B\) Macaroon or a \(B, C\).

An ordinary caveat is checked by looking at the request and the caveat and seeing if they match up. For instance, a Macaroon with an \`Operation=read\` caveat can be checked by looking to see if the request it accompanies is trying to write. Simple stuff.

A "third party \(3P\)" caveat works differently. 3P caveats demand that some other named system validate the request.

Users extract a little ticket from the 3P caveat \(that ticket is called a "CID"\) and hands it to the third party, along with anything else the third party might want. That third party resolves the caveat by generating a "discharge Macaroon", which is a whole 'nother token, tied cryptographically to the original 3P caveat. The user then presents both the original Macaroon and the discharge Macaroon with their request.

For instance: most Fly.io Macaroons require a logged\-in user \(usually a member of a particular organization\). We express that with a 3P caveat pointing to our authentication endpoint. That endpoint checks to see who you're logged in as, and produces an appropriate discharge, which accompanies the original Macaroon and \(in effect\) attests to you being logged in.

### Cryptography

All the cryptography in Macaroons is symmetric; there are no public keys.

We use SHA256 as our hash, and HMAC\-SHA256 as our authenticator.

We use ChaCha20/Poly1305 as the AEAD for third\-party caveats.

### Fly Macaroon Format

Our Macaroons are simple structs encoded with [MessagePack](<https://msgpack.org/index.html>). We use a binary encoding both for performance and to to encode deterministically, for cryptography. MessagePack is extraordinarily simple and you can reason about this code as if simply used JSON.

A typical Fly.io request from a user will require multiple tokens; the original "root" token, which says what you're allowed to do, and tokens to validate 3P caveats \(usually at least an authentication token\).

To represent that bundle of tokens, we define a \`FlyV1\` HTTP \`Authorization\` header scheme, which is simply a comma\-separated set of Base64'd Macaroons.

### Internal Deployment

See the \`flyio\` package for more details.

### Basic Library Usage

- Create a token with [New](<#New>).

- Add caveats \("attenuating" it\) with [Macaroon.Add](<#Macaroon.Add>).

- Sign and encode the token with [Macaroon.Encode](<#Macaroon.Encode>).

- Decode a binary token with [Decode](<#Decode>).

- Verify the signatures on a token with [Macaroon.Verify](<#Macaroon.Verify>). Note that the whole token has not been checked at this point\!

- Check the caveats \(the result of [Macaroon.Verify](<#Macaroon.Verify>)\) with [CaveatSet.Validate](<#CaveatSet.Validate>).

## Index

- [Constants](<#constants>)
- [Variables](<#variables>)
- [func DischargeCID\(ka EncryptionKey, location string, cid \[\]byte\) \(\[\]Caveat, \*Macaroon, error\)](<#DischargeCID>)
- [func FindPermissionAndDischargeTokens\(tokens \[\]\[\]byte, location string\) \(\[\]\*Macaroon, \[\]\[\]byte, \[\]\*Macaroon, \[\]\[\]byte, error\)](<#FindPermissionAndDischargeTokens>)
- [func GetCaveats\[T Caveat\]\(c \*CaveatSet\) \(ret \[\]T\)](<#GetCaveats>)
- [func Parse\(header string\) \(\[\]\[\]byte, error\)](<#Parse>)
- [func ParsePermissionAndDischargeTokens\(header string, location string\) \(\[\]byte, \[\]\[\]byte, error\)](<#ParsePermissionAndDischargeTokens>)
- [func RegisterCaveatType\(name string, typ CaveatType, zeroValue Caveat\)](<#RegisterCaveatType>)
- [func ThirdPartyCID\(encodedMacaroon \[\]byte, thirdPartyLocation string\) \(\[\]byte, error\)](<#ThirdPartyCID>)
- [func ToAuthorizationHeader\(toks ...\[\]byte\) string](<#ToAuthorizationHeader>)
- [func Validate\[A Access\]\(cs \*CaveatSet, accesses ...A\) error](<#Validate>)
- [type Access](<#Access>)
- [type Action](<#Action>)
  - [func ActionFromString\(ms string\) Action](<#ActionFromString>)
  - [func \(a Action\) IsSubsetOf\(other Action\) bool](<#Action.IsSubsetOf>)
  - [func \(a Action\) MarshalJSON\(\) \(\[\]byte, error\)](<#Action.MarshalJSON>)
  - [func \(a Action\) Remove\(other Action\) Action](<#Action.Remove>)
  - [func \(a Action\) String\(\) string](<#Action.String>)
  - [func \(a \*Action\) UnmarshalJSON\(b \[\]byte\) error](<#Action.UnmarshalJSON>)
- [type BindToParentToken](<#BindToParentToken>)
  - [func \(c \*BindToParentToken\) CaveatType\(\) CaveatType](<#BindToParentToken.CaveatType>)
  - [func \(c \*BindToParentToken\) IsAttestation\(\) bool](<#BindToParentToken.IsAttestation>)
  - [func \(c \*BindToParentToken\) Prohibits\(f Access\) error](<#BindToParentToken.Prohibits>)
- [type Caveat](<#Caveat>)
- [type Caveat3P](<#Caveat3P>)
  - [func \(c \*Caveat3P\) CaveatType\(\) CaveatType](<#Caveat3P.CaveatType>)
  - [func \(c \*Caveat3P\) IsAttestation\(\) bool](<#Caveat3P.IsAttestation>)
  - [func \(c \*Caveat3P\) Prohibits\(f Access\) error](<#Caveat3P.Prohibits>)
- [type CaveatSet](<#CaveatSet>)
  - [func DecodeCaveats\(buf \[\]byte\) \(\*CaveatSet, error\)](<#DecodeCaveats>)
  - [func NewCaveatSet\(caveats ...Caveat\) \*CaveatSet](<#NewCaveatSet>)
  - [func \(c \*CaveatSet\) DecodeMsgpack\(dec \*msgpack.Decoder\) error](<#CaveatSet.DecodeMsgpack>)
  - [func \(c CaveatSet\) EncodeMsgpack\(enc \*msgpack.Encoder\) error](<#CaveatSet.EncodeMsgpack>)
  - [func \(c CaveatSet\) MarshalJSON\(\) \(\[\]byte, error\)](<#CaveatSet.MarshalJSON>)
  - [func \(c CaveatSet\) MarshalMsgpack\(\) \(\[\]byte, error\)](<#CaveatSet.MarshalMsgpack>)
  - [func \(c \*CaveatSet\) UnmarshalJSON\(b \[\]byte\) error](<#CaveatSet.UnmarshalJSON>)
  - [func \(c \*CaveatSet\) Validate\(accesses ...Access\) error](<#CaveatSet.Validate>)
- [type CaveatType](<#CaveatType>)
- [type EncryptionKey](<#EncryptionKey>)
  - [func NewEncryptionKey\(\) EncryptionKey](<#NewEncryptionKey>)
- [type IfPresent](<#IfPresent>)
  - [func \(c \*IfPresent\) CaveatType\(\) CaveatType](<#IfPresent.CaveatType>)
  - [func \(c \*IfPresent\) IsAttestation\(\) bool](<#IfPresent.IsAttestation>)
  - [func \(c \*IfPresent\) Prohibits\(f Access\) error](<#IfPresent.Prohibits>)
- [type Macaroon](<#Macaroon>)
  - [func Decode\(buf \[\]byte\) \(\*Macaroon, error\)](<#Decode>)
  - [func New\(kid \[\]byte, loc string, key SigningKey\) \(\*Macaroon, error\)](<#New>)
  - [func \(m \*Macaroon\) Add\(caveats ...Caveat\) error](<#Macaroon.Add>)
  - [func \(m \*Macaroon\) Add3P\(ka EncryptionKey, loc string, cs ...Caveat\) error](<#Macaroon.Add3P>)
  - [func \(m \*Macaroon\) Bind\(parent \[\]byte\) error](<#Macaroon.Bind>)
  - [func \(m \*Macaroon\) BindToParentMacaroon\(parent \*Macaroon\) error](<#Macaroon.BindToParentMacaroon>)
  - [func \(m \*Macaroon\) Encode\(\) \(\[\]byte, error\)](<#Macaroon.Encode>)
  - [func \(m \*Macaroon\) Expiration\(\) time.Time](<#Macaroon.Expiration>)
  - [func \(m \*Macaroon\) ThirdPartyCID\(location string, existingDischarges ...\[\]byte\) \(\[\]byte, error\)](<#Macaroon.ThirdPartyCID>)
  - [func \(m \*Macaroon\) ThirdPartyCIDs\(existingDischarges ...\[\]byte\) \(map\[string\]\[\]byte, error\)](<#Macaroon.ThirdPartyCIDs>)
  - [func \(m \*Macaroon\) Verify\(k SigningKey, discharges \[\]\[\]byte, trusted3Ps map\[string\]EncryptionKey\) \(\*CaveatSet, error\)](<#Macaroon.Verify>)
- [type Nonce](<#Nonce>)
  - [func DecodeNonce\(buf \[\]byte\) \(Nonce, error\)](<#DecodeNonce>)
  - [func \(n \*Nonce\) DecodeMsgpack\(d \*msgpack.Decoder\) error](<#Nonce.DecodeMsgpack>)
  - [func \(n \*Nonce\) EncodeMsgpack\(e \*msgpack.Encoder\) error](<#Nonce.EncodeMsgpack>)
  - [func \(n Nonce\) MustEncode\(\) \[\]byte](<#Nonce.MustEncode>)
  - [func \(n \*Nonce\) UUID\(\) uuid.UUID](<#Nonce.UUID>)
- [type SigningKey](<#SigningKey>)
  - [func NewSigningKey\(\) SigningKey](<#NewSigningKey>)
- [type ValidityWindow](<#ValidityWindow>)
  - [func \(c \*ValidityWindow\) CaveatType\(\) CaveatType](<#ValidityWindow.CaveatType>)
  - [func \(c \*ValidityWindow\) IsAttestation\(\) bool](<#ValidityWindow.IsAttestation>)
  - [func \(c \*ValidityWindow\) Prohibits\(f Access\) error](<#ValidityWindow.Prohibits>)


## Constants

<a name="ActionAll"></a>

```go
const (
    ActionAll  = ActionRead | ActionWrite | ActionCreate | ActionDelete | ActionControl
    ActionNone = Action(0)
)
```

<a name="CavValidityWindow"></a>

```go
const (
    CavValidityWindow

    Cav3P
    CavBindToParentToken
    CavIfPresent

    // Globally-recognized user-registerable caveat types may be requested via
    // pull requests to this repository. Add a meaningful name of the caveat
    // type (e.g. CavAcmeCorpWidgetID) on the line prior to
    // CavMaxUserRegisterable.
    CavMinUserRegisterable = 1 << 32
    CavMaxUserRegisterable = 1<<48 - 1

    CavMinUserDefined = 1 << 48
    CavMaxUserDefined = 1<<64 - 2
    CavUnregistered   = 1<<64 - 1
)
```

<a name="EncryptionKeySize"></a>

```go
const (
    EncryptionKeySize = 32
)
```

## Variables

<a name="ErrUnrecognizedToken"></a>

```go
var (
    ErrUnrecognizedToken          = errors.New("bad token")
    ErrUnauthorized               = errors.New("unauthorized")
    ErrInvalidAccess              = fmt.Errorf("%w: bad data for token verification", ErrUnauthorized)
    ErrResourcesMutuallyExclusive = fmt.Errorf("%w: resources are mutually exclusive", ErrInvalidAccess)
    ErrResourceUnspecified        = fmt.Errorf("%w: must specify", ErrInvalidAccess)
    ErrUnauthorizedForResource    = fmt.Errorf("%w for", ErrUnauthorized)
    ErrUnauthorizedForAction      = fmt.Errorf("%w for", ErrUnauthorized)
    ErrBadCaveat                  = fmt.Errorf("%w: bad caveat", ErrUnauthorized)
)
```

<a name="DischargeCID"></a>
## func [DischargeCID](<https://github.com/superfly/macaroon/blob/main/cid.go#L35>)

```go
func DischargeCID(ka EncryptionKey, location string, cid []byte) ([]Caveat, *Macaroon, error)
```

Decyrpts the CID from the 3p caveat and prepares a discharge token. Returned caveats, if any, must be validated before issuing the discharge token to the user.

<a name="FindPermissionAndDischargeTokens"></a>
## func [FindPermissionAndDischargeTokens](<https://github.com/superfly/macaroon/blob/main/format.go#L82>)

```go
func FindPermissionAndDischargeTokens(tokens [][]byte, location string) ([]*Macaroon, [][]byte, []*Macaroon, [][]byte, error)
```



<a name="GetCaveats"></a>
## func [GetCaveats](<https://github.com/superfly/macaroon/blob/main/caveat_set.go#L73>)

```go
func GetCaveats[T Caveat](c *CaveatSet) (ret []T)
```

GetCaveats gets any caveats of type T, including those nested within IfPresent caveats.

<a name="Parse"></a>
## func [Parse](<https://github.com/superfly/macaroon/blob/main/format.go#L18>)

```go
func Parse(header string) ([][]byte, error)
```

Parses an Authorization header into its constituent tokens.

<a name="ParsePermissionAndDischargeTokens"></a>
## func [ParsePermissionAndDischargeTokens](<https://github.com/superfly/macaroon/blob/main/format.go#L63>)

```go
func ParsePermissionAndDischargeTokens(header string, location string) ([]byte, [][]byte, error)
```

Parse a string token and find the contained permission token for the given location.

<a name="RegisterCaveatType"></a>
## func [RegisterCaveatType](<https://github.com/superfly/macaroon/blob/main/caveat.go#L73>)

```go
func RegisterCaveatType(name string, typ CaveatType, zeroValue Caveat)
```

Register a caveat type for use with this library.

<a name="ThirdPartyCID"></a>
## func [ThirdPartyCID](<https://github.com/superfly/macaroon/blob/main/cid.go#L23>)

```go
func ThirdPartyCID(encodedMacaroon []byte, thirdPartyLocation string) ([]byte, error)
```

Checks the macaroon for a third party caveat for the specified location. Returns the caveat's encrypted CID, if found.

<a name="ToAuthorizationHeader"></a>
## func [ToAuthorizationHeader](<https://github.com/superfly/macaroon/blob/main/format.go#L105>)

```go
func ToAuthorizationHeader(toks ...[]byte) string
```

ToAuthorizationHeader formats a collection of tokens as an HTTP Authorization header.

<a name="Validate"></a>
## func [Validate](<https://github.com/superfly/macaroon/blob/main/caveat_set.go#L44>)

```go
func Validate[A Access](cs *CaveatSet, accesses ...A) error
```

Helper for validating concretely\-typed accesses.

<a name="Access"></a>
## type [Access](<https://github.com/superfly/macaroon/blob/main/access.go#L9-L18>)

Access represents the user's attempt to access some resource. Different caveats will require different contextual information.

```go
type Access interface {
    // The action being attempted by the principal
    GetAction() Action

    // The current time
    Now() time.Time

    // Callback for validating the structure
    Validate() error
}
```

<a name="Action"></a>
## type [Action](<https://github.com/superfly/macaroon/blob/main/action.go#L10>)

Action is an RWX\-style bitmap of actions that can be taken on a resource \(eg org, app, machine\). An Action can describe the permission limitations expressed by a caveat or the action a principal is attempting to take on a resource. The precise semantics of Actions are left to Caveat/AuthAttempt implementations.

```go
type Action uint16
```

<a name="ActionRead"></a>

```go
const (
    // ActionRead indicates reading attributes of the specified objects.
    ActionRead Action = 1 << iota

    // ActionWrite indicates writing attributes of the specified objects.
    ActionWrite

    // ActionCreate indicates creating the specified object. Since the ID of an
    // object will be unknown before creation, this is mostly meaningless
    // unless inherited from a parent. E.g. org:123:create lets you create
    // app:234 belonging to org:123.
    ActionCreate

    // ActionDelete indicates deleting the specified object.
    ActionDelete

    // ActionControl indicates changing the state of the specified object, but
    // not modifying other attributes. In practice, this mostly applies to
    // starting/stopping/signaling machines.
    ActionControl
)
```

<a name="ActionFromString"></a>
### func [ActionFromString](<https://github.com/superfly/macaroon/blob/main/action.go#L49>)

```go
func ActionFromString(ms string) Action
```



<a name="Action.IsSubsetOf"></a>
### func \(Action\) [IsSubsetOf](<https://github.com/superfly/macaroon/blob/main/action.go#L13>)

```go
func (a Action) IsSubsetOf(other Action) bool
```

IsSubsetOf returns wether all bits in p are set in other.

<a name="Action.MarshalJSON"></a>
### func \(Action\) [MarshalJSON](<https://github.com/superfly/macaroon/blob/main/action.go#L114>)

```go
func (a Action) MarshalJSON() ([]byte, error)
```



<a name="Action.Remove"></a>
### func \(Action\) [Remove](<https://github.com/superfly/macaroon/blob/main/action.go#L18>)

```go
func (a Action) Remove(other Action) Action
```

Remove returns the bits in p but not other

<a name="Action.String"></a>
### func \(Action\) [String](<https://github.com/superfly/macaroon/blob/main/action.go#L75>)

```go
func (a Action) String() string
```



<a name="Action.UnmarshalJSON"></a>
### func \(\*Action\) [UnmarshalJSON](<https://github.com/superfly/macaroon/blob/main/action.go#L101>)

```go
func (a *Action) UnmarshalJSON(b []byte) error
```



<a name="BindToParentToken"></a>
## type [BindToParentToken](<https://github.com/superfly/macaroon/blob/main/caveats.go#L112>)

BindToParentToken is used by discharge tokens to state that they may only be used to discharge 3P caveats for a specific root token or further attenuated versions of that token. This prevents a discharge token from being used with less attenuated versions of the specified token, effectively binding the discharge token to the root token. This caveat may appear multiple times to iteratively clamp down which versions of the root token the discharge token may be used with.

The parent token is identified by a prefix of the SHA256 digest of the token's signature.

```go
type BindToParentToken []byte
```

<a name="BindToParentToken.CaveatType"></a>
### func \(\*BindToParentToken\) [CaveatType](<https://github.com/superfly/macaroon/blob/main/caveats.go#L116>)

```go
func (c *BindToParentToken) CaveatType() CaveatType
```



<a name="BindToParentToken.IsAttestation"></a>
### func \(\*BindToParentToken\) [IsAttestation](<https://github.com/superfly/macaroon/blob/main/caveats.go#L126>)

```go
func (c *BindToParentToken) IsAttestation() bool
```



<a name="BindToParentToken.Prohibits"></a>
### func \(\*BindToParentToken\) [Prohibits](<https://github.com/superfly/macaroon/blob/main/caveats.go#L120>)

```go
func (c *BindToParentToken) Prohibits(f Access) error
```



<a name="Caveat"></a>
## type [Caveat](<https://github.com/superfly/macaroon/blob/main/caveat.go#L49-L64>)

Caveat is the interface implemented by all caveats.

```go
type Caveat interface {
    // The numeric caveat type identifier.
    CaveatType() CaveatType

    // Callback for checking if the authorization check is blocked by this
    // caveat. Implementors must take care to return appropriate error types,
    // as they have bearing on the evaluation of IfPresent caveats.
    // Specifically, returning ErrResourceUnspecified indicates that caveat
    // constrains access to a resource type that isn't specified by the Access.
    Prohibits(f Access) error

    // Whether or not this caveat type is an attestation. Attestations make a
    // positive assertion rather than constraining access to a resource. Most
    // caveats are not attestations.
    IsAttestation() bool
}
```

<a name="Caveat3P"></a>
## type [Caveat3P](<https://github.com/superfly/macaroon/blob/main/caveats.go#L10-L17>)

Caveat3P is a requirement that the token be presented along with a 3P discharge token.

```go
type Caveat3P struct {
    Location string
    VID      []byte // used by the initial issuer to verify discharge macaroon
    CID      []byte // used by the 3p service to construct discharge macaroon
    // contains filtered or unexported fields
}
```

<a name="Caveat3P.CaveatType"></a>
### func \(\*Caveat3P\) [CaveatType](<https://github.com/superfly/macaroon/blob/main/caveats.go#L21>)

```go
func (c *Caveat3P) CaveatType() CaveatType
```



<a name="Caveat3P.IsAttestation"></a>
### func \(\*Caveat3P\) [IsAttestation](<https://github.com/superfly/macaroon/blob/main/caveats.go#L31>)

```go
func (c *Caveat3P) IsAttestation() bool
```



<a name="Caveat3P.Prohibits"></a>
### func \(\*Caveat3P\) [Prohibits](<https://github.com/superfly/macaroon/blob/main/caveats.go#L25>)

```go
func (c *Caveat3P) Prohibits(f Access) error
```



<a name="CaveatSet"></a>
## type [CaveatSet](<https://github.com/superfly/macaroon/blob/main/caveat_set.go#L12-L14>)

CaveatSet is how a set of caveats is serailized/encoded.

```go
type CaveatSet struct {
    Caveats []Caveat
}
```

<a name="DecodeCaveats"></a>
### func [DecodeCaveats](<https://github.com/superfly/macaroon/blob/main/caveat_set.go#L28>)

```go
func DecodeCaveats(buf []byte) (*CaveatSet, error)
```

Decodes a set of serialized caveats.

<a name="NewCaveatSet"></a>
### func [NewCaveatSet](<https://github.com/superfly/macaroon/blob/main/caveat_set.go#L23>)

```go
func NewCaveatSet(caveats ...Caveat) *CaveatSet
```

Create a new CaveatSet comprised of the specified caveats.

<a name="CaveatSet.DecodeMsgpack"></a>
### func \(\*CaveatSet\) [DecodeMsgpack](<https://github.com/superfly/macaroon/blob/main/caveat_set.go#L111>)

```go
func (c *CaveatSet) DecodeMsgpack(dec *msgpack.Decoder) error
```

Implements msgpack.CustomDecoder

<a name="CaveatSet.EncodeMsgpack"></a>
### func \(CaveatSet\) [EncodeMsgpack](<https://github.com/superfly/macaroon/blob/main/caveat_set.go#L92>)

```go
func (c CaveatSet) EncodeMsgpack(enc *msgpack.Encoder) error
```

Implements msgpack.CustomEncoder

<a name="CaveatSet.MarshalJSON"></a>
### func \(CaveatSet\) [MarshalJSON](<https://github.com/superfly/macaroon/blob/main/caveat_set.go#L147>)

```go
func (c CaveatSet) MarshalJSON() ([]byte, error)
```



<a name="CaveatSet.MarshalMsgpack"></a>
### func \(CaveatSet\) [MarshalMsgpack](<https://github.com/superfly/macaroon/blob/main/caveat_set.go#L87>)

```go
func (c CaveatSet) MarshalMsgpack() ([]byte, error)
```

Implements msgpack.Marshaler

<a name="CaveatSet.UnmarshalJSON"></a>
### func \(\*CaveatSet\) [UnmarshalJSON](<https://github.com/superfly/macaroon/blob/main/caveat_set.go#L172>)

```go
func (c *CaveatSet) UnmarshalJSON(b []byte) error
```



<a name="CaveatSet.Validate"></a>
### func \(\*CaveatSet\) [Validate](<https://github.com/superfly/macaroon/blob/main/caveat_set.go#L39>)

```go
func (c *CaveatSet) Validate(accesses ...Access) error
```

Validates that the caveat set permits the specified accesses.

<a name="CaveatType"></a>
## type [CaveatType](<https://github.com/superfly/macaroon/blob/main/caveat.go#L13>)

A numeric identifier for caveat types. Values less than CavMinUserRegisterable \(0x100000000\) are reserved for use by fly.io. Users may request a globally\-recognized caveat type via pull requests to this repository. Implementations that don't need to integrate with fly.io itself can pick from the user\-defined range \(\>0x1000000000000\).

```go
type CaveatType uint64
```

<a name="EncryptionKey"></a>
## type [EncryptionKey](<https://github.com/superfly/macaroon/blob/main/crypto.go#L20>)



```go
type EncryptionKey []byte
```

<a name="NewEncryptionKey"></a>
### func [NewEncryptionKey](<https://github.com/superfly/macaroon/blob/main/crypto.go#L26>)

```go
func NewEncryptionKey() EncryptionKey
```



<a name="IfPresent"></a>
## type [IfPresent](<https://github.com/superfly/macaroon/blob/main/caveats.go#L40-L43>)

IfPresent attempts to apply the specified \`Ifs\` caveats if the relevant resources are specified. If none of the relevant resources are specified, the \`Else\` caveats are applied.

This is only meaningful to use with "resource" caveats: org, app, feature, volume, machine. Notably, it explicitly doesn't work with the Mutations caveat.

```go
type IfPresent struct {
    Ifs  *CaveatSet `json:"ifs"`
    Else Action     `json:"else"`
}
```

<a name="IfPresent.CaveatType"></a>
### func \(\*IfPresent\) [CaveatType](<https://github.com/superfly/macaroon/blob/main/caveats.go#L47>)

```go
func (c *IfPresent) CaveatType() CaveatType
```



<a name="IfPresent.IsAttestation"></a>
### func \(\*IfPresent\) [IsAttestation](<https://github.com/superfly/macaroon/blob/main/caveats.go#L72>)

```go
func (c *IfPresent) IsAttestation() bool
```



<a name="IfPresent.Prohibits"></a>
### func \(\*IfPresent\) [Prohibits](<https://github.com/superfly/macaroon/blob/main/caveats.go#L51>)

```go
func (c *IfPresent) Prohibits(f Access) error
```



<a name="Macaroon"></a>
## type [Macaroon](<https://github.com/superfly/macaroon/blob/main/macaroon.go#L109-L116>)

Macaroon is the fully\-functioning internal representation of a token \-\-\- you've got a Macaroon either because you're constructing a new token yourself, or because you've parsed a token from the wire.

```go
type Macaroon struct {
    Nonce         Nonce     `json:"-"`
    Location      string    `json:"location"`
    UnsafeCaveats CaveatSet `json:"caveats"`
    Tail          []byte    `json:"-"`
    // contains filtered or unexported fields
}
```

<a name="Decode"></a>
### func [Decode](<https://github.com/superfly/macaroon/blob/main/macaroon.go#L158>)

```go
func Decode(buf []byte) (*Macaroon, error)
```

Decode parses a token off the wire; to get usable caveats, call Verify.

<a name="New"></a>
### func [New](<https://github.com/superfly/macaroon/blob/main/macaroon.go#L140>)

```go
func New(kid []byte, loc string, key SigningKey) (*Macaroon, error)
```

New creates a new token given a key\-id string \(which can be any opaque string and doesn't need to be cryptographically random or anything; the key\-id is how you're going to relate the token back to a key you've saved somewhere; it's probably a database rowid somehow\) and a location, which is ordinarily a URL. The key is the signing secret.

<a name="Macaroon.Add"></a>
### func \(\*Macaroon\) [Add](<https://github.com/superfly/macaroon/blob/main/macaroon.go#L181>)

```go
func (m *Macaroon) Add(caveats ...Caveat) error
```

Add adds a caveat to a Macaroon, adjusting the tail signature in the process. This is how you'd "attenuate" a token, taking a read\-write token and turning it into a read\-only token, for instance.

<a name="Macaroon.Add3P"></a>
### func \(\*Macaroon\) [Add3P](<https://github.com/superfly/macaroon/blob/main/macaroon.go#L446>)

```go
func (m *Macaroon) Add3P(ka EncryptionKey, loc string, cs ...Caveat) error
```

Add3P adds a third\-party caveat to a Macaroon. A third\-party caveat is checked not by evaluating what it means, but instead by looking for a "discharge token" \-\-\- a second token sent along with the token that says "some other service verified that the claims corresponding to this caveat are true".

Add3P needs a key, which binds this token to the service that validates it. Every authentication caveat, for instance, shares an authentication key; the key connects the root service to the authentication service.

Add3P takes a location, which is used to figure out which keys to use to check which caveats. The location is normally a URL. The authentication service has an authentication location URL.

<a name="Macaroon.Bind"></a>
### func \(\*Macaroon\) [Bind](<https://github.com/superfly/macaroon/blob/main/macaroon.go#L416>)

```go
func (m *Macaroon) Bind(parent []byte) error
```

Bind binds this \(discharge\) token to the specified root token \(parent\) with a BindToParentToken caveat.

<a name="Macaroon.BindToParentMacaroon"></a>
### func \(\*Macaroon\) [BindToParentMacaroon](<https://github.com/superfly/macaroon/blob/main/macaroon.go#L425>)

```go
func (m *Macaroon) BindToParentMacaroon(parent *Macaroon) error
```



<a name="Macaroon.Encode"></a>
### func \(\*Macaroon\) [Encode](<https://github.com/superfly/macaroon/blob/main/macaroon.go#L260>)

```go
func (m *Macaroon) Encode() ([]byte, error)
```

Encode encodes a Macaroon to bytes after creating it or decoding it and adding more caveats.

<a name="Macaroon.Expiration"></a>
### func \(\*Macaroon\) [Expiration](<https://github.com/superfly/macaroon/blob/main/macaroon.go#L518>)

```go
func (m *Macaroon) Expiration() time.Time
```

Expiration calculates when this macaroon will expire

<a name="Macaroon.ThirdPartyCID"></a>
### func \(\*Macaroon\) [ThirdPartyCID](<https://github.com/superfly/macaroon/blob/main/macaroon.go#L505>)

```go
func (m *Macaroon) ThirdPartyCID(location string, existingDischarges ...[]byte) ([]byte, error)
```

Checks the macaroon for a third party caveat for the specified location. Returns the caveat's encrypted CID, if found.

<a name="Macaroon.ThirdPartyCIDs"></a>
### func \(\*Macaroon\) [ThirdPartyCIDs](<https://github.com/superfly/macaroon/blob/main/macaroon.go#L480>)

```go
func (m *Macaroon) ThirdPartyCIDs(existingDischarges ...[]byte) (map[string][]byte, error)
```

ThirdPartyCIDs extracts the encrypted CIDs from a token's third party caveats. Each is identified by the location of the third party. The CID can then be exchanged with the third party for a discharge token. Third party caveats are checked against existing discharge tokens and discharged caveats are omitted from the results.

<a name="Macaroon.Verify"></a>
### func \(\*Macaroon\) [Verify](<https://github.com/superfly/macaroon/blob/main/macaroon.go#L273>)

```go
func (m *Macaroon) Verify(k SigningKey, discharges [][]byte, trusted3Ps map[string]EncryptionKey) (*CaveatSet, error)
```

Verify checks the signature on a Decode\(\)'ed Macaroon and returns the the set of caveats that require validation against the user's request. This excludes caveats that have already been validated \(e.g. 3P caveats and others relating to the signing of the Macaroon\).

<a name="Nonce"></a>
## type [Nonce](<https://github.com/superfly/macaroon/blob/main/nonce.go#L22-L26>)

Nonce encodes the key ID that signed the macaroon as well as some randomness

```go
type Nonce struct {
    // contains filtered or unexported fields
}
```

<a name="DecodeNonce"></a>
### func [DecodeNonce](<https://github.com/superfly/macaroon/blob/main/macaroon.go#L170>)

```go
func DecodeNonce(buf []byte) (Nonce, error)
```

DecodeNonce parses just the [Nonce](<#Nonce>) from an encoded [Macaroon](<#Macaroon>). You'd want to do this, for instance, to look metadata up by the keyid of the [Macaroon](<#Macaroon>), which is encoded in the [Nonce](<#Nonce>).

<a name="Nonce.DecodeMsgpack"></a>
### func \(\*Nonce\) [DecodeMsgpack](<https://github.com/superfly/macaroon/blob/main/nonce.go#L49>)

```go
func (n *Nonce) DecodeMsgpack(d *msgpack.Decoder) error
```

DecodeMsgpack implements msgpack.CustomDecoder

<a name="Nonce.EncodeMsgpack"></a>
### func \(\*Nonce\) [EncodeMsgpack](<https://github.com/superfly/macaroon/blob/main/nonce.go#L83>)

```go
func (n *Nonce) EncodeMsgpack(e *msgpack.Encoder) error
```

DecodeMsgpack implements msgpack.CustomDecoder

<a name="Nonce.MustEncode"></a>
### func \(Nonce\) [MustEncode](<https://github.com/superfly/macaroon/blob/main/nonce.go#L97>)

```go
func (n Nonce) MustEncode() []byte
```



<a name="Nonce.UUID"></a>
### func \(\*Nonce\) [UUID](<https://github.com/superfly/macaroon/blob/main/nonce.go#L42>)

```go
func (n *Nonce) UUID() uuid.UUID
```

UUID is a simple globally unique identifier string for a nonce.

<a name="SigningKey"></a>
## type [SigningKey](<https://github.com/superfly/macaroon/blob/main/crypto.go#L19>)



```go
type SigningKey []byte
```

<a name="NewSigningKey"></a>
### func [NewSigningKey](<https://github.com/superfly/macaroon/blob/main/crypto.go#L22>)

```go
func NewSigningKey() SigningKey
```



<a name="ValidityWindow"></a>
## type [ValidityWindow](<https://github.com/superfly/macaroon/blob/main/caveats.go#L75-L78>)

ValidityWindow establishes the window of time the token is valid for.

```go
type ValidityWindow struct {
    NotBefore int64 `json:"not_before"`
    NotAfter  int64 `json:"not_after"`
}
```

<a name="ValidityWindow.CaveatType"></a>
### func \(\*ValidityWindow\) [CaveatType](<https://github.com/superfly/macaroon/blob/main/caveats.go#L82>)

```go
func (c *ValidityWindow) CaveatType() CaveatType
```



<a name="ValidityWindow.IsAttestation"></a>
### func \(\*ValidityWindow\) [IsAttestation](<https://github.com/superfly/macaroon/blob/main/caveats.go#L100>)

```go
func (c *ValidityWindow) IsAttestation() bool
```



<a name="ValidityWindow.Prohibits"></a>
### func \(\*ValidityWindow\) [Prohibits](<https://github.com/superfly/macaroon/blob/main/caveats.go#L86>)

```go
func (c *ValidityWindow) Prohibits(f Access) error
```



Generated by [gomarkdoc](<https://github.com/princjef/gomarkdoc>)
